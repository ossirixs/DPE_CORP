{% extends "common/base.html" %}

{% block content_title %}
    <title>DPE - Detalle Empresa</title>
{% endblock%}

{% block content_subtitle %}
    <div class="app-page-title">
        <div class="page-title-wrapper">
            <div class="page-title-heading">
                <div class="page-title-icon">
                    <i class="fas fa-building icon-gradient bg-night-fade">
                    </i>
                </div>
                <div>
                    {% if company_main %} {{ company_main.company_name }} - {% endif %}{{ company.company_name }}
                    <div class="page-title-subheading">
                        Administracion de Pruebas Psicometricas.
                    </div>
                </div>
            </div>   
        </div>
    </div> 
{% endblock%}

{% block content_container %}
<div class="row">


    <div class="col-md-12 col-lg-12">
        <div class="main-card mb-3 card">
            <div class="card-header-tab card-header">
                <div class="btn-actions-pane-left">
                    <div class="nav">
                        <a id="tests" href="javascript:void(0);" class="border-0 btn-pill btn-wide btn-transition active btn btn-outline-alternate" onclick="toogleForm(this)">Pruebas</a>
                        <a id="codes" href="javascript:void(0);" class="border-0 btn-pill btn-wide btn-transition btn btn-outline-alternate" onclick="toogleForm(this)">Codigos de Pruebas</a>
                        <a id="company" href="javascript:void(0);" class="border-0 btn-pill btn-wide btn-transition btn btn-outline-alternate" onclick="toogleForm(this)">Modificar Empresa</a>
                        <a id="search" href="javascript:void(0);" class="border-0 btn-pill btn-wide btn-transition btn btn-outline-alternate" onclick="toogleForm(this)">Modificar Usarios</a>
                        <a id="create" href="javascript:void(0);" class="border-0 btn-pill btn-wide btn-transition btn btn-outline-alternate" onclick="toogleForm(this)">Crear Usuarios</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% comment %} TESTS {% endcomment %}
                    {%if user.type == "ADMIN_DPE"%} 
                        <div id="tests-form-id" class="card-section">
                            <h5 class="card-title">Pruebas Asignadas:</h5>
                            <table class="mb-0 table">
                                <thead>
                                <tr>
                                    <th>Typo de prueba</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for assigned_test in assigned_tests %}
                                    <tr>
                                        <td>
                                            {{assigned_test.test.test_name}}
                                        </td>

                                    </tr>    
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                    {% else %}
                        <div id="tests-form-id" class="card-section">
                            <h5 class="card-title">Pruebas Asignadas:</h5>
                            <table class="mb-0 table">
                                <thead>
                                <tr>
                                    <th>Typo de prueba</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for assigned_test in assigned_tests %}
                                    <tr>
                                        <td>
                                            {{assigned_test.test.test_name}}
                                        </td>

                                    </tr>    
                                {% endfor %}
                                </tbody>
                            </table>
                            
                        </div>
                    {% endif %}
                {% comment %} CODES {% endcomment %}
                <div id="codes-id" class="card-section d-none">
                    <h5 class="card-title">Crear nuevo codigo:</h5>
                    <form method="POST"  class="">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="col-md-4">
                                <label for="test-id" class="">Prueba</label>
                                <select name="test" id="test-id" class="form-control" required>
                                    <option value="">--</option>
                                        <option value=1>test1</option>                                                                                
                                        <option value=2>test2</option>                                                                                
                                        <option value=3>test3</option>                                                                                
                                </select>   
                            </div>
                            <div class="col-md-4">
                                <label for="company-id" class="">Compania</label>
                                <select name="company" id="company-id" class="form-control" required>
                                    <option value="">--</option>
                                    {% for company in companies %}
                                        <option value={{company.id}}>{{company.company_name}}</option>                                                                                
                                    {% endfor %}
                                </select>   
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label for="expiration-id" class="">Fecha de Expiracion</label>
                                    <input name="expiration" id="expiration-id" type="date" class="form-control" value="" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <button class="mt-2 btn btn-primary">Crear Nuevo Codigo</button>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="company_id" value={{company.id}}>
                        <input type="hidden" name="create_code" value=1>
                        
                    </form>
                    <br/>
                    <h5 class="card-title">Codigos para esta compania:</h5>
                    <table class="mb-0 table">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Prueba</th>
                            <th>Codigo de acceso</th>
                            <th>Creador</th>
                            <th>Expiracion</th>
                            <th>Estatus</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for code in company_codes %}
                            <tr>
                                <th scope="row">1</th>
                                <td>{{ code.test }}</td>
                                <td>{{ code.code }}</td>
                                <td>{{ code.user.username }}</td>
                                <td>{{ code.expiration }}</td>
                                <td>{{ code.activate }}</td>
                            </tr>    
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% comment %} MODIFY {% endcomment %}
                <div id="company-data-id" class="card-section d-none">
                    <h5 class="card-title">Datos generales:</h5>
                    <form method="POST"  >
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="col-md-4">
                                <div class="position-relative form-group">
                                    <label for="name-id" class="">Empresa</label><input name="company_name" id="name-id" type="text" class="form-control" value="{{company.company_name}}">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label for="contact-id" class="">Nombre de contacto</label><input name="company_contact" id="contact-id" type="text" class="form-control" value="{{ company.company_contact }}">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="position-relative form-group">
                                    <label for="email-id" class="">Email</label><input name="company_email" id="email-id" placeholder="" type="email" class="form-control" value="{{company.company_email}}">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="company_id" value={{company.company_id}}>
                        <input type="hidden" name="update" value=1>
                        <button class="mt-2 btn btn-primary">Actualizar</button>
                    </form>
                </div>
                {% comment %} SEARCH USERS {% endcomment %}
                <div id="search-users-form-id" class="card-section d-none">
                    <form method="POST" action="{% url 'company:user_detail' company.company_name %}"   class="">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="col-md-4">
                                <select name="company_user_id" id="company-id" class="form-control" required>
                                    <option value="">--</option>
                                    {% for company_user in company_users %}
                                        <option value={{company_user.id}}>{{company_user.first_name}}</option>                                                                                
                                    {% endfor %}
                                </select>   
                            </div>
                            <input type="hidden" name="company" value={{company.id}}>
                            <button type="submit" class="btn btn-primary">Seleccionar</button>
                        </div>
                    </form>
                </div>
                {% comment %} CREATE USERS {% endcomment %}
                <div id="create-form-id" class="card-section d-none">
                    <form method="POST"  class="">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label for="username-id" class="">Nombre de usuario</label><input name="username" id="username-id" type="text" class="form-control" value="">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label for="username-id" class="">Password</label><input name="password1" id="password-id" type="password" class="form-control" value="">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label for="username-id" class="">Confirmar Password</label><input name="password2" id="password-id" type="password" class="form-control" value="">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-3">
                                    <div class="position-relative form-group">
                                        <label for="name-id" class="">Nombre</label><input name="first_name" id="name-id" type="text" class="form-control" value="">
                                    </div>
                            </div>
                            <div class="col-md-3">
                                    <div class="position-relative form-group">
                                        <label for="last-name-id" class="">Paterno</label><input name="last_name" id="last-name-id" type="text" class="form-control" value="">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="position-relative form-group">
                                        <label for="second-last-name-id" class="">Materno</label><input name="second_last_name" id="second-last-name-id" type="text" class="form-control" value="">
                                    </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label for="email-id" class="">Email</label><input name="email" id="email-id" type="email" class="form-control" value="{{email}}">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="company" value={{company.id}}>
                        <input type="hidden" name="type" value="{% if company.company_main == 0 %}CLIENT_MAIN{% else %}CLIENT{% endif %}">
                        <input type="hidden" name="company_main" value={% if company.company_main == 0 %}0{% else %}{{company.company_main}}{% endif %}>
                        <input type="hidden" name="create_user" value=1>
                        <button class="mt-2 btn btn-primary">Crear Usuario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    let forms = '';
    let buttons = '';

    document.addEventListener("DOMContentLoaded", function(e) {
        forms = document.querySelectorAll('.card-section');
        buttons = document.querySelectorAll('.btn-pill');

    });
    function toogleForm(btn){
        let selected_form = ''
        forms.forEach((form) => {
            let form_id = form.id;
            if (form_id.includes(btn.id) && form.classList.contains('d-none')){
                form.classList.remove('d-none');
                selected_form = form
            }else if (!form_id.includes(btn.id) && !form.classList.contains('d-none')){
                form.classList.add('d-none');
            }

            if(!btn.classList.contains('active')){
                btn.classList.add('active');
            }else{
                btn.classList.remove('active');
            }
        });

        buttons.forEach((btn) => {

            if(!selected_form.id.includes(btn.id)){
                btn.classList.remove('active');
            }
        });
    }

    let saved_code = '{{saved_code}}'
    if ( saved_code ){
        showSwal('success', 'Nuevo Código Generado', '{{ saved_code.code }}', '');
    }

</script>
{% endblock%}
